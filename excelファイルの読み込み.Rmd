
# (PART) excelファイルを読み込む {-#readingexcel}

excellファイルを読みこむには、`readxl`パッケージを使います。

# 一つのexcelファイルを読み込む

* dataフォルダ（`data/`で表現）に入っている「ペンギン.xlsx」を開きます。
* `read_xlsx()`関数を使います。したがって、以下すべてファイル形式は`.xlsx`を想定します。
  + `read_xls()`や`read_excel()`もあるので、用途によって使い分けられます。ファイル形式が混ざっている時は`read_excel()`が有用かもしれません。

```{r}
library(readxl)

# excelファイルの読み込み
df <- 
 read_xlsx("data/ペンギン.xlsx")

# データの表示
df
``` 

上記コードを実行すると、RStudioの右上（デフォルトの配置であれば）のEnvironmentタブに、

`df  344 obs. of 9 variables`

という表示が出ると思います。つまり、344行のデータと9列の変数が入っているデータということを示しています。

`df`と打つことで、デフォルトでは最初の10行分のデータが表示されます。ここでは紙面の都合で設定を変えているので5つだけにしています。表示された最初の行にも、`A tibble: 344 x 9`と、行数x列数の情報が出ています。表示しきれなかった行は、`with 339 more rows`と省略され、表示しきれなかった列は、`body_mass_g <dbl>, sex <chr>, year <dbl>`と、名前と<型名>が表示されます。

## 最高な機能だよ！パスの自動補完

 * `read_xlsx("")`と打った後に、`" "`の中にカーソルを置いて、tabキーを押すと、プロジェクトの中身が一覧で表示されるので、選んでいくだけで目的のファイルがキーボードを打つことなしに選べます！

*  上の階層のフォルダに行きたいときは、`" "`の中に`../`と打てば可能です。その後にtabキーを押せば上の階層のフォルダが選べます。


## 列名がひどい場合の読み込み
```{r}
read_xlsx("data/ペンギン（ひどい列名）ver.xlsx")
```

読めることは読めますが、今後のデータ処理を進めるうえで不安が残ります。

### スペースや記号などを自動的に変換してくれる関数できれいに

`janitor`パッケージの`clean_names()`関数を使って、列名に入り込んでいるスペースや記号などを安全な記号に変換します。

なお、日本語の列名では、引数に`case = "old_janitor"`をつけないと読みにくい結果になります。


```{r}
library(tidyverse)
library(janitor)

read_xlsx("data/ペンギン（ひどい列名）ver.xlsx") %>% 
  clean_names(case = "old_janitor")
```


さて、ここで使われている `%>%` は非常に大事なので解説しておきます。

#### %>% とは？

「パイプ」と読みます。処理を重ねてコードに書いていきたい際に重宝し、現代の`tidyverse`を使ったRのコードに欠かせないものです。

たとえば、dfのspecies列を選択する、という処理の

```{r eval = FALSE}
select(df, species)
```

は

```{r eval = FALSE}
df %>% select(species)
```


と書けます。 `%>%`の左側にあるものを右側の最初の部分（第1引数）に渡すという働きです。パイプの利点は、いくつもつないで書いていけることです。たとえば、種類別にクチバシの長さの平均値を出したいときには次のようにできます。

```{r}
df %>% 
  group_by(species) %>% 
  summarise(平均値 = mean(bill_length_mm, na.rm = TRUE))
```

以下では`%>%`を多用していきます。

なお、ショートカット`ctrl + shit + M`で出せます。
（Macだと `⇧⌘M`らしい）

### 全角←→半角を自動で

`stringi`パッケージの`stri_trans_nfkc()`関数を使って、変数名で全角-半角のばらつきを統一させます。


ここでは、変数名をリネームするのに`rename_with()`関数を使いました。すべての変数に対し、全角文字を含んでいたら半角に直すというコードになります。

```{r}
library(stringi)
read_xlsx("data/ペンギン（ひどい列名）ver.xlsx") %>% 
  rename_with(~stri_trans_nfkc(.),
              everything())
```

### 上記の合わせ技

`%>%` でつなぎ合わせて1つの実行で合わせてしまうこともできます。

```{r}
read_xlsx("data/ペンギン（ひどい列名）ver.xlsx") %>% 
  rename_with(~stri_trans_nfkc(.),
              everything()) %>% 
    clean_names(case = "old_janitor")

```
