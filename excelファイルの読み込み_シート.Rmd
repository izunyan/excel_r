# シートを指定して読みこむ
## シート名の確認

`readxl`の`excel_sheets()`関数でシート名の一覧を取得できます。

```{r}
excel_sheets("data/ペンギン（シート別）.xlsx")
```

## 普通の読み込み
```{r}
read_xlsx("data/ペンギン（シート別）.xlsx")
```

デフォルトでは一番最初のシートのデータが読みこまれます。ここでは、シート「アデリー」が読み込まれました。




## シートを指定した読み込み
```{r}
read_excel("data/ペンギン（シート別）.xlsx", sheet = "ジェンツー" )
```

引数の`sheet =`にシート名を指定することで読み込めます。 


## すべてのシートから読み込み {#dflist}

ここで一気にレベルが上がりますが、これこそがRを使ってexcelファイルを読みこむ便利な部分なので、その魅力をみていきましょう。

```{r}
path_name <- "data/ペンギン（シート別）.xlsx" # データのパスを格納

# シート名を取得しそれぞれから読み込んでリストにまとめる
df_list <-
  excel_sheets(path_name) %>%                     
  set_names() %>%           # 名前付きベクトルにする
  map(read_excel, path =  path_name)

# 読みこんだデータ全体のリスト構造を表示
str(df_list, width = 80)
```

それぞれのexcelシートから読みこまれた3つのデータ（アデリー、ジェンツー、ヒゲ）はデータフレームとして、`df_all`にリストとしてまとめて格納されています。リストは最初は理解が難しいですが、慣れるとなんでもリストにしたくなるくらい便利なものです。リストの中身を個別に取り出してみてみましょう

```{r}
df_list$ジェンツー
```

これは、df_allというリストの中の、ジェンツーという要素を取り出す、というコードです。`$`が「の中の」という意味を表しています。自分でコードを打つと、`df_all$`と打った時点で、中の要素の一覧が表示されるはずなので、そこからクリックして選ぶこともできます。

それでは、先ほど実行した読み込みコードの解説をします。

```{r eval = FALSE}
path_name <- "data/ペンギン（シート別）.xlsx"
```

これは、単にファイルの場所を`path_name`に格納しただけです。自分のデータで試してみたいときは、基本的にここのパス名を変えるだけで実行できるはずです。

```{r eval = FALSE}
df_list <-
  excel_sheets(path_name) %>%                    
  set_names() %>%                           
  map(read_excel, path =  path_name) 
```

`excel_sheets()`は上で実行したのと同じです。実行結果はベクトルとして保存されています。`set_names()`は、ベクトルを名前付きベクトルにする働きをします。なので、ここでできるのは、

```{r}
excel_sheets(path_name) %>%                    
  set_names()
```

です。それぞれについて`map()`を使って`read_excel()`を1つ1つのシート（ここでは作成した名前付きベクトルの要素）に適用していき、1つのリストにまとめるという作業をします。


```{r eval=FALSE, include=FALSE}
# clean_names()も組み合わせる
df_list <-
  excel_sheets(path_name) %>%                    
  set_names() %>%                           
  map(read_excel, path =  path_name) %>%
  map(clean_names, case = "old_janitor")    # 列名をきれいに
```



### 一つのデータフレームにする

`bind_rows()`は、データフレームを縦に連結します。データフレームがリストになったものが引数にくると、それらをすべて縦につなげてくれます。引数`.id =`で、リストの要素名を変数の値として入れることができるので、どのデータフレームから来たのか識別することが可能になります。ここでは`group`という名前にしています。

```{r}
df_all <- 
bind_rows(df_list, .id = "group")

```

`slice()`関数を使って、最初の3行と最後の3行だけを表示してどんなものができたか確認します。`1:3`は1行目から3行目、`(n()-2):n()`は、列数（ただし現在のgroup内）を表す`n()`とそれから-2行した`(n()-2)`で表されています。

```{r}
df_all %>% 
  slice(1:3, (n()-2):n())
```

それぞれ、別々に出したほうが分かりやすいかもしれません。

```{r}
# 最初の3行
df_all %>% slice_head(n = 3)
```

```{r}
# 最後の3行
df_all %>% slice_tail(n = 3)
```
